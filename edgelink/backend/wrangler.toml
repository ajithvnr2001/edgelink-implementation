name = "edgelink-production"
main = "src/index.ts"
compatibility_date = "2024-11-07"
workers_dev = true

# Worker Routes - Critical for custom domain support
# These routes determine which domains/paths trigger this Worker
[[routes]]
pattern = "*/*"  # Catch-all for custom domains (CRITICAL for Custom Hostnames)
zone_name = "shortedbro.xyz"

[[routes]]
pattern = "*.shortedbro.xyz/*"  # All subdomains of shortedbro.xyz
zone_name = "shortedbro.xyz"

[[routes]]
pattern = "go.shortedbro.xyz/*"  # Primary short link domain
zone_name = "shortedbro.xyz"

# KV Namespace for link storage (fast redirects)
[[kv_namespaces]]
binding = "LINKS_KV"
id = "d343d816e5904857b49d35938c7f39cf"
preview_id = "46db878aed4b40b6b1dce78fab668170"

# D1 Database for user data and metadata
[[d1_databases]]
binding = "DB"
database_name = "edgelink-production"
database_id = "d5f676e0-b43f-4ac9-ab2c-acd1ddcda86b"

# Analytics Engine for click tracking
# Note: Dual-write strategy - writes to both Analytics Engine and D1 for redundancy
# D1 provides fallback when Analytics Engine is unavailable
[[analytics_engine_datasets]]
binding = "ANALYTICS_ENGINE"
dataset = "edgelink_analytics"

# R2 Bucket for file storage (exports, imports) (temporarily disabled - needs to be created)
# [[r2_buckets]]
# binding = "R2_BUCKET"
# bucket_name = "edgelink-storage"

# Environment variables
[vars]
ENVIRONMENT = "production"
FRONTEND_URL = "https://shortedbro.xyz"
ALLOW_REGISTRATION = "true"
NODE_ENV = "development"
EMAIL_FROM_ADDRESS = "EdgeLink <noreply@go.shortedbro.xyz>"
DODO_BASE_URL = "https://test.dodopayments.com"
# FALLBACK_URL = "https://example.com" # Optional: Proxy to this URL when slug not found (for root domain usage)

# Secrets (set via: wrangler secret put <NAME>)
# JWT_SECRET - Secret key for JWT signing/verification (Legacy, maintained for API keys)
# Run: wrangler secret put JWT_SECRET
#
# Email Service (Resend)
# RESEND_API_KEY - API key from Resend dashboard (starts with re_)
# Run: wrangler secret put RESEND_API_KEY
#
# DodoPayments Integration
# DODO_API_KEY - DodoPayments API key from dashboard
# DODO_WEBHOOK_SECRET - Webhook signing secret from DodoPayments
# DODO_PRODUCT_ID - Product ID for Pro plan ($10/month subscription)
# Run: wrangler secret put DODO_API_KEY
# Run: wrangler secret put DODO_WEBHOOK_SECRET
# Run: wrangler secret put DODO_PRODUCT_ID
#
# Cloudflare API Credentials for Custom Hostnames (required for automatic custom domain setup)
# CF_ZONE_ID - Zone ID for shortedbro.xyz (found in Cloudflare Dashboard → shortedbro.xyz → Overview)
# CF_API_TOKEN - API Token with "Zone.SSL and Certificates:Edit" + "Zone.Custom Hostnames:Edit" permissions
# CF_ACCOUNT_ID - Account ID (optional, found in dashboard URL)
# Run: wrangler secret put CF_ZONE_ID
# Run: wrangler secret put CF_API_TOKEN

# Rate Limiting
[[unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1001"
simple = { limit = 1000, period = 86400 }

# Cron Triggers for scheduled tasks
# Runs daily at 2 AM UTC for:
# - Cleaning up expired links
# - Sending 80-day warnings to unverified accounts
# - Deleting 90-day unverified accounts
# - Cleaning expired tokens
# - Cleaning up inactive links (free: 90/180 days, pro: 365 days)
[triggers]
crons = ["0 2 * * *"]  # Every day at 2 AM UTC
