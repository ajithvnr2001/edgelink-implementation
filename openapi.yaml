openapi: 3.0.3
info:
  title: EdgeLink API
  description: |
    **EdgeLink** is a developer-first URL shortener built on Cloudflare Edge with advanced routing, analytics, and automation features.

    ## Features

    ### Core Features
    - üîó **URL Shortening** - Create short links with custom slugs
    - üìä **Real-time Analytics** - Track clicks, devices, countries, referrers
    - üåç **Geographic Routing** - Route by country (Pro)
    - üì± **Device Routing** - Route by mobile/tablet/desktop (Pro)
    - üîÄ **Referrer Routing** - Route by traffic source (Pro)
    - ‚è∞ **Time-based Routing** - Route by hour/day (Pro)
    - üß™ **A/B Testing** - Split test destinations (Pro)
    - üîí **Password Protection** - Secure links (Pro)
    - üìÖ **Link Expiration** - Time & click-based limits
    - üé® **QR Code Generation** - SVG/PNG formats (Pro)
    - üåê **Custom Domains** - Use your own domain (Pro)
    - üîî **Webhooks** - Real-time event notifications (Pro)
    - üîë **API Keys** - Long-lived authentication tokens
    - üë• **Team Management** - Collaborate with teams (Pro)
    - üì¶ **Bulk Import/Export** - CSV operations
    - ü§ñ **AI Slug Suggestions** - Smart slug generation
    - üñºÔ∏è **Link Previews** - Open Graph metadata

    ## Authentication

    EdgeLink supports two authentication methods:

    1. **JWT Tokens** - Short-lived (24h), for user sessions
    2. **API Keys** - Long-lived (1 year), for automation

    Both use `Authorization: Bearer <token>` header.

    ## Rate Limits

    - **Anonymous**: 10 requests/hour
    - **Free Plan**: 1,000 requests/day
    - **Pro Plan**: 10,000 requests/day

    Rate limit headers are included in all responses:
    - `X-RateLimit-Limit`
    - `X-RateLimit-Remaining`
    - `X-RateLimit-Reset`

    ## Getting Started

    1. **Sign up**: `POST /auth/signup`
    2. **Get JWT token**: Use signup response or `POST /auth/login`
    3. **Create short link**: `POST /api/shorten`
    4. **Track analytics**: `GET /api/analytics/{slug}`

    ## Support

    - **Documentation**: [Full API Docs](https://docs.edgelink.dev)
    - **GitHub**: [EdgeLink Repository](https://github.com/yourusername/edgelink)
    - **Support**: support@edgelink.dev

  version: 1.0.0
  contact:
    name: EdgeLink Support
    email: support@edgelink.dev
    url: https://docs.edgelink.dev
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://edgelink-production.quoteviral.workers.dev
    description: Production API (Cloudflare Workers)

tags:
  - name: Authentication
    description: User authentication and session management
  - name: URL Shortening
    description: Create and manage short links
  - name: Link Management
    description: CRUD operations for links
  - name: Analytics
    description: Click tracking and statistics
  - name: Smart Routing
    description: Device, geographic, and referrer-based routing (Pro)
  - name: A/B Testing
    description: Split testing for links (Pro)
  - name: Custom Domains
    description: Manage custom domains (Pro)
  - name: API Keys
    description: Generate and manage API keys
  - name: Webhooks
    description: Event-driven notifications (Pro)
  - name: User Management
    description: User profile and account operations
  - name: Teams
    description: Team collaboration features (Pro)
  - name: Bulk Operations
    description: Import and export links
  - name: Utilities
    description: Helper endpoints (slug suggestions, previews, QR codes)

security:
  - BearerAuth: []
  - ApiKeyAuth: []

paths:
  # ==========================================
  # Authentication Endpoints
  # ==========================================

  /auth/signup:
    post:
      tags:
        - Authentication
      summary: Create new account
      description: Register a new user account and receive a JWT token
      operationId: signup
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: securePassword123
                plan:
                  type: string
                  enum: [free, pro]
                  default: free
                  example: free
      responses:
        '201':
          description: Account created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWT authentication token
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login to account
      description: Authenticate with email/password and receive JWT token
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: securePassword123
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWT authentication token
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh JWT token
      description: Get a new JWT token before expiration
      operationId: refreshToken
      responses:
        '200':
          description: Token refreshed
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: New JWT token
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout
      description: Invalidate current session
      operationId: logout
      responses:
        '200':
          description: Logged out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully

  # ==========================================
  # URL Shortening
  # ==========================================

  /api/shorten:
    post:
      tags:
        - URL Shortening
      summary: Create short link
      description: |
        Create a shortened URL. Works for both anonymous and authenticated users.

        **Anonymous users**:
        - Links expire in 30 days
        - No advanced features
        - Rate limit: 10/hour

        **Authenticated users**:
        - Custom expiration
        - Password protection (Pro)
        - Advanced routing (Pro)
        - QR codes (Pro)
      operationId: createShortLink
      security:
        - {}
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShortenRequest'
            examples:
              basic:
                summary: Basic URL shortening
                value:
                  url: https://example.com/very-long-url
              custom_slug:
                summary: With custom slug
                value:
                  url: https://example.com/product
                  custom_slug: product-launch
              with_expiration:
                summary: With expiration
                value:
                  url: https://example.com/promo
                  custom_slug: black-friday
                  expires_at: "2025-12-31T23:59:59Z"
                  max_clicks: 1000
              password_protected:
                summary: Password protected (Pro)
                value:
                  url: https://example.com/secret
                  custom_slug: secret-link
                  password: mySecretPassword
      responses:
        '201':
          description: Short link created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShortLinkResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/ProRequired'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

  # ==========================================
  # Link Management
  # ==========================================

  /api/links:
    get:
      tags:
        - Link Management
      summary: List user's links
      description: Get paginated list of all links with search and filtering
      operationId: listLinks
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: search
          in: query
          schema:
            type: string
          description: Search query
        - name: searchField
          in: query
          schema:
            type: string
            enum: [all, slug, destination, date]
            default: all
      responses:
        '200':
          description: List of links
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LinkListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/links/{slug}:
    put:
      tags:
        - Link Management
      summary: Update link
      description: |
        Update link destination and configuration.

        **Pro features**:
        - Change slug (new_slug)
        - Password protection
        - Advanced routing
      operationId: updateLink
      parameters:
        - $ref: '#/components/parameters/SlugParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateLinkRequest'
      responses:
        '200':
          description: Link updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  slug:
                    type: string
                  slug_changed:
                    type: boolean
                  old_slug:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/ProRequired'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Link Management
      summary: Delete link
      description: Permanently delete a short link
      operationId: deleteLink
      parameters:
        - $ref: '#/components/parameters/SlugParam'
      responses:
        '200':
          description: Link deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Link deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'

  /api/links/{slug}/qr:
    get:
      tags:
        - Utilities
      summary: Generate QR code (Pro)
      description: Generate QR code for short link in SVG or PNG format
      operationId: generateQRCode
      parameters:
        - $ref: '#/components/parameters/SlugParam'
        - name: format
          in: query
          schema:
            type: string
            enum: [svg, png]
            default: svg
      responses:
        '200':
          description: QR code generated
          content:
            image/svg+xml:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
        '403':
          $ref: '#/components/responses/ProRequired'

  # ==========================================
  # Analytics
  # ==========================================

  /api/stats/{slug}:
    get:
      tags:
        - Analytics
      summary: Get basic stats
      description: Get basic click statistics for a link
      operationId: getBasicStats
      parameters:
        - $ref: '#/components/parameters/SlugParam'
      responses:
        '200':
          description: Basic statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  slug:
                    type: string
                  total_clicks:
                    type: integer
                  created_at:
                    type: string
                    format: date-time

  /api/analytics/{slug}:
    get:
      tags:
        - Analytics
      summary: Get detailed analytics
      description: Get comprehensive analytics with device, country, and referrer breakdown
      operationId: getDetailedAnalytics
      parameters:
        - $ref: '#/components/parameters/SlugParam'
        - name: range
          in: query
          schema:
            type: string
            enum: ['7d', '30d']
            default: '7d'
      responses:
        '200':
          description: Detailed analytics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Analytics'

  /api/analytics/summary:
    get:
      tags:
        - Analytics
      summary: Get analytics summary
      description: Get overview of all links performance
      operationId: getAnalyticsSummary
      responses:
        '200':
          description: Analytics summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsSummary'

  # ==========================================
  # Smart Routing (Pro)
  # ==========================================

  /api/links/{slug}/routing/device:
    post:
      tags:
        - Smart Routing
      summary: Configure device routing (Pro)
      description: Route users to different URLs based on device type
      operationId: setDeviceRouting
      parameters:
        - $ref: '#/components/parameters/SlugParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeviceRouting'
      responses:
        '200':
          description: Device routing configured
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  slug:
                    type: string
                  device_routing:
                    $ref: '#/components/schemas/DeviceRouting'
        '403':
          $ref: '#/components/responses/ProRequired'

  /api/links/{slug}/routing/geo:
    post:
      tags:
        - Smart Routing
      summary: Configure geographic routing (Pro)
      description: Route users to different URLs based on country
      operationId: setGeoRouting
      parameters:
        - $ref: '#/components/parameters/SlugParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GeoRouting'
      responses:
        '200':
          description: Geographic routing configured
        '403':
          $ref: '#/components/responses/ProRequired'

  /api/links/{slug}/routing/referrer:
    post:
      tags:
        - Smart Routing
      summary: Configure referrer routing (Pro)
      description: Route users to different URLs based on traffic source
      operationId: setReferrerRouting
      parameters:
        - $ref: '#/components/parameters/SlugParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReferrerRouting'
      responses:
        '200':
          description: Referrer routing configured
        '403':
          $ref: '#/components/responses/ProRequired'

  /api/links/{slug}/routing/time:
    post:
      tags:
        - Smart Routing
      summary: Configure time-based routing (Pro)
      description: Route users to different URLs based on time and day
      operationId: setTimeRouting
      parameters:
        - $ref: '#/components/parameters/SlugParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TimeRouting'
      responses:
        '200':
          description: Time routing configured
        '403':
          $ref: '#/components/responses/ProRequired'

  /api/links/{slug}/routing:
    get:
      tags:
        - Smart Routing
      summary: Get routing configuration
      description: Get all routing rules for a link
      operationId: getRouting
      parameters:
        - $ref: '#/components/parameters/SlugParam'
      responses:
        '200':
          description: Routing configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoutingConfig'

    delete:
      tags:
        - Smart Routing
      summary: Delete all routing rules
      description: Remove all routing configuration from a link
      operationId: deleteRouting
      parameters:
        - $ref: '#/components/parameters/SlugParam'
      responses:
        '200':
          description: Routing deleted

  # ==========================================
  # A/B Testing (Pro)
  # ==========================================

  /api/links/{slug}/ab-test:
    post:
      tags:
        - A/B Testing
      summary: Create A/B test (Pro)
      description: Split test two destination URLs
      operationId: createABTest
      parameters:
        - $ref: '#/components/parameters/SlugParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ABTestRequest'
      responses:
        '200':
          description: A/B test created
        '403':
          $ref: '#/components/responses/ProRequired'

    get:
      tags:
        - A/B Testing
      summary: Get A/B test results (Pro)
      description: Get performance metrics for A/B test
      operationId: getABTestResults
      parameters:
        - $ref: '#/components/parameters/SlugParam'
      responses:
        '200':
          description: A/B test results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ABTestResults'

    delete:
      tags:
        - A/B Testing
      summary: Stop A/B test (Pro)
      description: End A/B test and set permanent destination
      operationId: stopABTest
      parameters:
        - $ref: '#/components/parameters/SlugParam'
      responses:
        '200':
          description: A/B test stopped

  # ==========================================
  # API Keys
  # ==========================================

  /api/keys:
    post:
      tags:
        - API Keys
      summary: Generate API key
      description: Create a new long-lived API key for automation
      operationId: generateAPIKey
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: My Python Script
                expires_in_days:
                  type: integer
                  minimum: 1
                  maximum: 365
                  default: 365
      responses:
        '201':
          description: API key generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIKeyResponse'

    get:
      tags:
        - API Keys
      summary: List API keys
      description: Get all API keys (prefixes only, not full keys)
      operationId: listAPIKeys
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                type: object
                properties:
                  keys:
                    type: array
                    items:
                      $ref: '#/components/schemas/APIKey'
                  total:
                    type: integer

  /api/keys/{keyId}:
    delete:
      tags:
        - API Keys
      summary: Revoke API key
      description: Immediately invalidate an API key
      operationId: revokeAPIKey
      parameters:
        - name: keyId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: API key revoked

  # ==========================================
  # Custom Domains (Pro)
  # ==========================================

  /api/domains:
    post:
      tags:
        - Custom Domains
      summary: Add custom domain (Pro)
      description: Add a custom domain for short links
      operationId: addDomain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - domain
              properties:
                domain:
                  type: string
                  example: short.yourdomain.com
      responses:
        '201':
          description: Domain added
        '403':
          $ref: '#/components/responses/ProRequired'

    get:
      tags:
        - Custom Domains
      summary: List domains (Pro)
      description: Get all custom domains
      operationId: listDomains
      responses:
        '200':
          description: List of domains
          content:
            application/json:
              schema:
                type: object
                properties:
                  domains:
                    type: array
                    items:
                      $ref: '#/components/schemas/CustomDomain'

  /api/domains/{domainId}/verify:
    post:
      tags:
        - Custom Domains
      summary: Verify domain ownership (Pro)
      description: Verify DNS configuration for custom domain
      operationId: verifyDomain
      parameters:
        - name: domainId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Domain verified

  /api/domains/{domainId}:
    delete:
      tags:
        - Custom Domains
      summary: Delete domain (Pro)
      description: Remove custom domain
      operationId: deleteDomain
      parameters:
        - name: domainId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Domain deleted

  # ==========================================
  # Webhooks (Pro)
  # ==========================================

  /api/webhooks:
    post:
      tags:
        - Webhooks
      summary: Create webhook (Pro)
      description: Set up webhook for link events
      operationId: createWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookRequest'
      responses:
        '201':
          description: Webhook created
        '403':
          $ref: '#/components/responses/ProRequired'

    get:
      tags:
        - Webhooks
      summary: List webhooks (Pro)
      description: Get all configured webhooks
      operationId: listWebhooks
      responses:
        '200':
          description: List of webhooks
          content:
            application/json:
              schema:
                type: object
                properties:
                  webhooks:
                    type: array
                    items:
                      $ref: '#/components/schemas/Webhook'

  /api/webhooks/{webhookId}:
    delete:
      tags:
        - Webhooks
      summary: Delete webhook (Pro)
      description: Remove webhook configuration
      operationId: deleteWebhook
      parameters:
        - name: webhookId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Webhook deleted

  # ==========================================
  # Bulk Operations
  # ==========================================

  /api/import/links:
    post:
      tags:
        - Bulk Operations
      summary: Bulk import links
      description: Import multiple links from CSV file
      operationId: bulkImportLinks
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Import completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  imported:
                    type: integer
                  failed:
                    type: integer
                  errors:
                    type: array
                    items:
                      type: string

  /api/export/links:
    get:
      tags:
        - Bulk Operations
      summary: Export all links
      description: Export all user links as CSV or JSON
      operationId: exportLinks
      parameters:
        - name: format
          in: query
          schema:
            type: string
            enum: [csv, json]
            default: json
      responses:
        '200':
          description: Export file
          content:
            text/csv:
              schema:
                type: string
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Link'

  /api/export/analytics/{slug}:
    get:
      tags:
        - Bulk Operations
      summary: Export analytics
      description: Export analytics data as CSV or JSON
      operationId: exportAnalytics
      parameters:
        - $ref: '#/components/parameters/SlugParam'
        - name: format
          in: query
          schema:
            type: string
            enum: [csv, json]
            default: json
        - name: range
          in: query
          schema:
            type: string
            enum: ['7d', '30d', '90d', 'all']
            default: '30d'
      responses:
        '200':
          description: Export file

  # ==========================================
  # Utilities
  # ==========================================

  /api/suggest-slug:
    post:
      tags:
        - Utilities
      summary: Get AI slug suggestions
      description: Generate smart slug suggestions based on destination URL
      operationId: suggestSlug
      security:
        - {}
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - url
              properties:
                url:
                  type: string
                  format: uri
      responses:
        '200':
          description: Slug suggestions
          content:
            application/json:
              schema:
                type: object
                properties:
                  suggestions:
                    type: array
                    items:
                      type: string
                    example: [product-launch, new-product, launch-2025]

  /api/preview:
    post:
      tags:
        - Utilities
      summary: Get link preview
      description: Fetch Open Graph metadata for a URL
      operationId: getLinkPreview
      security:
        - {}
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - url
              properties:
                url:
                  type: string
                  format: uri
      responses:
        '200':
          description: Link preview
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LinkPreview'

  # ==========================================
  # User Management
  # ==========================================

  /api/user/profile:
    get:
      tags:
        - User Management
      summary: Get user profile
      description: Get current user's profile information
      operationId: getUserProfile
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

    put:
      tags:
        - User Management
      summary: Update user profile
      description: Update user profile information
      operationId: updateUserProfile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Profile updated

  /api/user/delete:
    post:
      tags:
        - User Management
      summary: Delete account immediately
      description: Permanently delete user account and all data
      operationId: deleteAccount
      responses:
        '200':
          description: Account deleted

  /api/user/request-deletion:
    post:
      tags:
        - User Management
      summary: Request account deletion
      description: Request account deletion with 30-day grace period
      operationId: requestAccountDeletion
      responses:
        '200':
          description: Deletion requested

  /api/user/cancel-deletion:
    post:
      tags:
        - User Management
      summary: Cancel account deletion
      description: Cancel pending account deletion request
      operationId: cancelAccountDeletion
      responses:
        '200':
          description: Deletion cancelled

  /api/user/export:
    get:
      tags:
        - User Management
      summary: Export user data (GDPR)
      description: Export all user data in JSON format
      operationId: exportUserData
      responses:
        '200':
          description: User data export
          content:
            application/json:
              schema:
                type: object

  # ==========================================
  # Public Redirect
  # ==========================================

  /{slug}:
    get:
      tags:
        - URL Shortening
      summary: Redirect to destination
      description: |
        Public redirect endpoint. Handles all smart routing logic:
        1. A/B Testing
        2. Time-based Routing
        3. Device Routing
        4. Geographic Routing
        5. Referrer Routing
        6. Default Destination
      operationId: redirectToDestination
      security: []
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
          example: abc123
        - name: X-Link-Password
          in: header
          schema:
            type: string
          description: Password for password-protected links
      responses:
        '301':
          description: Permanent redirect
          headers:
            Location:
              schema:
                type: string
        '302':
          description: Temporary redirect
          headers:
            Location:
              schema:
                type: string
        '404':
          description: Link not found
        '410':
          description: Link expired

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from /auth/login or /auth/signup

    ApiKeyAuth:
      type: http
      scheme: bearer
      description: |
        API key starting with 'elk_' from POST /api/keys

        Example: `Authorization: Bearer elk_98z7n3wCDv36mmyvuTpmqxRXaERJHulr`

  parameters:
    SlugParam:
      name: slug
      in: path
      required: true
      schema:
        type: string
      description: Short link identifier
      example: abc123

  schemas:
    User:
      type: object
      properties:
        user_id:
          type: string
          example: usr_abc123
        email:
          type: string
          format: email
          example: user@example.com
        plan:
          type: string
          enum: [free, pro]
          example: free
        created_at:
          type: string
          format: date-time

    ShortenRequest:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          format: uri
          maxLength: 2048
          example: https://example.com/very-long-url
        custom_slug:
          type: string
          pattern: '^[a-zA-Z0-9-]{5,20}$'
          example: my-link
        custom_domain:
          type: string
          example: short.yourdomain.com
        expires_at:
          type: string
          format: date-time
          example: '2025-12-31T23:59:59Z'
        max_clicks:
          type: integer
          minimum: 1
          example: 1000
        password:
          type: string
          description: Password protection (Pro only)
        utm_template:
          type: string
          example: utm_source=twitter&utm_medium=social

    ShortLinkResponse:
      type: object
      properties:
        slug:
          type: string
          example: abc123
        short_url:
          type: string
          format: uri
          example: https://edgelink-production.quoteviral.workers.dev/abc123
        expires_in:
          type: integer
          description: Seconds until expiration
          example: 2592000
        qr_code_url:
          type: string
          format: uri
          description: QR code URL (Pro only)

    Link:
      type: object
      properties:
        slug:
          type: string
        destination:
          type: string
          format: uri
        custom_domain:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          nullable: true
        max_clicks:
          type: integer
          nullable: true
        click_count:
          type: integer
        password_protected:
          type: boolean
        device_routing:
          $ref: '#/components/schemas/DeviceRouting'
        geo_routing:
          $ref: '#/components/schemas/GeoRouting'
        referrer_routing:
          $ref: '#/components/schemas/ReferrerRouting'
        ab_testing:
          type: object
          nullable: true
        utm_params:
          type: string
          nullable: true

    LinkListResponse:
      type: object
      properties:
        links:
          type: array
          items:
            $ref: '#/components/schemas/Link'
        total:
          type: integer
        page:
          type: integer
        limit:
          type: integer
        totalPages:
          type: integer

    UpdateLinkRequest:
      type: object
      required:
        - destination
      properties:
        destination:
          type: string
          format: uri
        new_slug:
          type: string
          pattern: '^[a-zA-Z0-9-]{5,20}$'
          description: Change slug (Pro only)
        expires_at:
          type: string
          format: date-time
        max_clicks:
          type: integer
        password:
          type: string

    Analytics:
      type: object
      properties:
        slug:
          type: string
        total_clicks:
          type: integer
        unique_visitors:
          type: integer
        time_range:
          type: string
          enum: ['7d', '30d']
        breakdown:
          type: object
          properties:
            devices:
              type: object
              additionalProperties:
                type: integer
              example:
                mobile: 2716
                desktop: 2170
                tablet: 546
            countries:
              type: object
              additionalProperties:
                type: integer
              example:
                US: 1630
                GB: 815
            referrers:
              type: object
              additionalProperties:
                type: integer
              example:
                twitter.com: 1086
                direct: 978
            browsers:
              type: object
              additionalProperties:
                type: integer
        timeline:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              clicks:
                type: integer

    AnalyticsSummary:
      type: object
      properties:
        total_links:
          type: integer
        total_clicks:
          type: integer
        total_unique_visitors:
          type: integer
        clicks_today:
          type: integer
        clicks_this_week:
          type: integer
        clicks_this_month:
          type: integer
        top_links:
          type: array
          items:
            type: object
            properties:
              slug:
                type: string
              clicks:
                type: integer
              destination:
                type: string

    DeviceRouting:
      type: object
      properties:
        mobile:
          type: string
          format: uri
          example: https://m.example.com
        tablet:
          type: string
          format: uri
          example: https://tablet.example.com
        desktop:
          type: string
          format: uri
          example: https://www.example.com

    GeoRouting:
      type: object
      properties:
        routes:
          type: object
          additionalProperties:
            type: string
            format: uri
          example:
            US: https://example.com/us
            GB: https://example.com/uk
            default: https://example.com

    ReferrerRouting:
      type: object
      properties:
        routes:
          type: object
          additionalProperties:
            type: string
            format: uri
          example:
            twitter.com: https://example.com/twitter
            linkedin.com: https://example.com/linkedin
            default: https://example.com/direct

    TimeRouting:
      type: object
      properties:
        rules:
          type: array
          items:
            type: object
            required:
              - start_hour
              - end_hour
              - destination
            properties:
              start_hour:
                type: integer
                minimum: 0
                maximum: 23
              end_hour:
                type: integer
                minimum: 0
                maximum: 23
              days:
                type: array
                items:
                  type: integer
                  minimum: 0
                  maximum: 6
                description: Days of week (0=Sunday, 6=Saturday)
              timezone:
                type: string
                example: America/New_York
              destination:
                type: string
                format: uri

    RoutingConfig:
      type: object
      properties:
        slug:
          type: string
        destination:
          type: string
          format: uri
        routing:
          type: object
          properties:
            device:
              $ref: '#/components/schemas/DeviceRouting'
            geo:
              $ref: '#/components/schemas/GeoRouting'
            time:
              type: object
              nullable: true
            referrer:
              $ref: '#/components/schemas/ReferrerRouting'

    ABTestRequest:
      type: object
      required:
        - variant_a
        - variant_b
      properties:
        variant_a:
          type: string
          format: uri
          example: https://example.com/version-a
        variant_b:
          type: string
          format: uri
          example: https://example.com/version-b
        split:
          type: integer
          minimum: 0
          maximum: 100
          default: 50
          description: Percentage of traffic to variant A

    ABTestResults:
      type: object
      properties:
        slug:
          type: string
        variant_a:
          type: object
          properties:
            url:
              type: string
            clicks:
              type: integer
            conversion_rate:
              type: number
        variant_b:
          type: object
          properties:
            url:
              type: string
            clicks:
              type: integer
            conversion_rate:
              type: number

    APIKeyResponse:
      type: object
      properties:
        key_id:
          type: string
          example: key_abc123xyz
        api_key:
          type: string
          example: elk_98z7n3wCDv36mmyvuTpmqxRXaERJHulr
        key_prefix:
          type: string
          example: elk_98z7n3w
        name:
          type: string
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        warning:
          type: string
          example: Save this API key now. You will not be able to see it again!
        usage:
          type: object
          properties:
            header:
              type: string
            example:
              type: string

    APIKey:
      type: object
      properties:
        key_id:
          type: string
        key_prefix:
          type: string
        name:
          type: string
        last_used_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time

    CustomDomain:
      type: object
      properties:
        domain_id:
          type: string
        domain:
          type: string
          example: short.yourdomain.com
        verified:
          type: boolean
        created_at:
          type: string
          format: date-time

    WebhookRequest:
      type: object
      required:
        - url
        - events
      properties:
        url:
          type: string
          format: uri
          example: https://your-server.com/webhooks/edgelink
        events:
          type: array
          items:
            type: string
            enum: [link.clicked, link.created, link.updated, link.deleted]
        secret:
          type: string
          description: Secret for webhook signature verification

    Webhook:
      type: object
      properties:
        webhook_id:
          type: string
        url:
          type: string
          format: uri
        events:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time

    LinkPreview:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        image:
          type: string
          format: uri
        site_name:
          type: string

    Error:
      type: object
      required:
        - error
        - code
      properties:
        error:
          type: string
          example: Invalid URL
        code:
          type: string
          example: INVALID_URL

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Invalid request parameters
            code: BAD_REQUEST

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Authentication required
            code: AUTH_REQUIRED

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Link not found or access denied
            code: NOT_FOUND

    ProRequired:
      description: Pro feature required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: This feature requires a Pro plan
            code: PRO_FEATURE_REQUIRED

    RateLimitExceeded:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
        X-RateLimit-Remaining:
          schema:
            type: integer
        X-RateLimit-Reset:
          schema:
            type: integer
        Retry-After:
          schema:
            type: integer
      content:
        application/json:
          schema:
            allOf:
              - $ref: '#/components/schemas/Error'
              - type: object
                properties:
                  limit:
                    type: integer
                  remaining:
                    type: integer
                  resetAfter:
                    type: integer
          example:
            error: Rate limit exceeded
            code: RATE_LIMIT_EXCEEDED
            limit: 1000
            remaining: 0
            resetAfter: 3600
